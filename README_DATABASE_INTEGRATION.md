# Kube-Tide æ•°æ®åº“ API æ•´åˆ

## ğŸ‰ æ–°åŠŸèƒ½å‘å¸ƒ

Kube-Tide ç°åœ¨æ”¯æŒ**æ•°æ®åº“ API æ•´åˆ**åŠŸèƒ½ï¼è¿™æ˜¯ä¸€ä¸ªé‡å¤§æ›´æ–°ï¼Œä¸ºå¹³å°å¸¦æ¥äº†å¼ºå¤§çš„æ•°æ®æŒä¹…åŒ–å’Œåˆ†æèƒ½åŠ›ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

### ğŸ”„ åŒè½¨åˆ¶æ¶æ„

- **Kubernetes API** - å®æ—¶æ“ä½œå’Œç®¡ç†
- **æ•°æ®åº“ API** - æ•°æ®æŒä¹…åŒ–ã€ç»Ÿè®¡åˆ†æå’Œå†å²æŸ¥è¯¢

### ğŸš€ æ ¸å¿ƒä¼˜åŠ¿

- âœ… **æ— ç¼é›†æˆ** - å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹
- âœ… **å¼‚æ­¥åŒæ­¥** - ä¸å½±å“ Kubernetes API æ€§èƒ½
- âœ… **æ™ºèƒ½æ›´æ–°** - è‡ªåŠ¨æ£€æµ‹å’Œæ›´æ–°æ•°æ®åº“è®°å½•
- âœ… **é”™è¯¯å®¹é”™** - æ•°æ®åº“æ•…éšœä¸å½±å“ Kubernetes æ“ä½œ
- âœ… **å¤šæ•°æ®åº“æ”¯æŒ** - SQLite (å¼€å‘) å’Œ PostgreSQL (ç”Ÿäº§)

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯ç”¨æ•°æ®åº“åŠŸèƒ½

```bash
# ä½¿ç”¨ SQLite (æ¨èç”¨äºå¼€å‘)
export ENABLE_DATABASE=true
export DB_TYPE=sqlite
export DB_SQLITE_PATH=./data/kube_tide.db

# å¯åŠ¨æœåŠ¡å™¨
./bin/server
```

### 2. ä½¿ç”¨ç°æœ‰ API (è‡ªåŠ¨åŒæ­¥)

```bash
# åˆ›å»ºéƒ¨ç½² (ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“)
curl -X POST http://localhost:8080/api/clusters/my-cluster/namespaces/default/deployments \
  -H "Content-Type: application/json" \
  -d '{"name": "nginx", "replicas": 3, "containers": [{"name": "nginx", "image": "nginx:1.20"}]}'

# æŸ¥è¯¢éƒ¨ç½² (ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“)
curl http://localhost:8080/api/clusters/my-cluster/deployments
```

### 3. ä½¿ç”¨æ•°æ®åº“ API (æ–°å¢)

```bash
# è·å–éƒ¨ç½²ç»Ÿè®¡
curl http://localhost:8080/api/v1/db/clusters/my-cluster/deployments/count

# è·å–å†å²æ•°æ® (åˆ†é¡µ)
curl "http://localhost:8080/api/v1/db/clusters/my-cluster/deployments?page=1&page_size=10"
```

## ğŸ“Š API å¯¹æ¯”

| åŠŸèƒ½ | Kubernetes API | æ•°æ®åº“ API | è¯´æ˜ |
|------|----------------|------------|------|
| å®æ—¶æ“ä½œ | âœ… | âŒ | åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤èµ„æº |
| æ•°æ®æŸ¥è¯¢ | âœ… | âœ… | è·å–èµ„æºä¿¡æ¯ |
| å†å²è®°å½• | âŒ | âœ… | æŸ¥çœ‹å†å²æ•°æ® |
| ç»Ÿè®¡åˆ†æ | âŒ | âœ… | æ•°é‡ç»Ÿè®¡ã€è¶‹åŠ¿åˆ†æ |
| åˆ†é¡µæŸ¥è¯¢ | âŒ | âœ… | å¤§æ•°æ®é‡åˆ†é¡µå¤„ç† |
| æ€§èƒ½ | å®æ—¶ | ç¼“å­˜ | ä¸åŒçš„æ€§èƒ½ç‰¹å¾ |

## ğŸ—ï¸ æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ UI   â”‚â”€â”€â”€â–¶â”‚  API ç½‘å…³   â”‚â”€â”€â”€â–¶â”‚ Kubernetes  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   é›†ç¾¤      â”‚
                          â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â–²
                   â”‚  æ•°æ®åº“ API â”‚           â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                          â”‚              å¼‚æ­¥åŒæ­¥
                          â–¼                 â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
                   â”‚   æ•°æ®åº“    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ (SQLite/PG) â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡

```bash
# åŸºæœ¬é…ç½®
ENABLE_DATABASE=true          # å¯ç”¨æ•°æ®åº“åŠŸèƒ½
DB_TYPE=sqlite               # æ•°æ®åº“ç±»å‹: sqlite æˆ– postgres

# SQLite é…ç½®
DB_SQLITE_PATH=./data/kube_tide.db

# PostgreSQL é…ç½®
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=your_password
DB_NAME=kube_tide
DB_SSL_MODE=disable

# è¿æ¥æ± é…ç½®
DB_MAX_OPEN_CONNS=25         # æœ€å¤§æ‰“å¼€è¿æ¥æ•°
DB_MAX_IDLE_CONNS=5          # æœ€å¤§ç©ºé—²è¿æ¥æ•°
DB_CONN_MAX_LIFETIME=5m      # è¿æ¥æœ€å¤§ç”Ÿå­˜æ—¶é—´
```

## ğŸ“ˆ ä½¿ç”¨åœºæ™¯

### 1. å¼€å‘ç¯å¢ƒ

```bash
# ä½¿ç”¨ SQLiteï¼Œç®€å•å¿«é€Ÿ
ENABLE_DATABASE=true DB_TYPE=sqlite ./bin/server
```

### 2. ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨ PostgreSQLï¼Œé«˜æ€§èƒ½é«˜å¯ç”¨
ENABLE_DATABASE=true \
DB_TYPE=postgres \
DB_HOST=postgres.example.com \
DB_USER=kube_tide \
DB_PASSWORD=secure_password \
./bin/server
```

### 3. æ•°æ®åˆ†æ

```bash
# è·å–é›†ç¾¤èµ„æºç»Ÿè®¡
curl http://localhost:8080/api/v1/db/clusters/prod/deployments/count
curl http://localhost:8080/api/v1/db/clusters/prod/services/count

# è·å–å†å²æ•°æ®è¿›è¡Œåˆ†æ
curl "http://localhost:8080/api/v1/db/clusters/prod/deployments?page=1&page_size=100"
```

## ğŸ§ª æµ‹è¯•

è¿è¡Œé›†æˆæµ‹è¯•ï¼š

```bash
# è¿è¡Œæ•°æ®åº“é›†æˆæµ‹è¯•
./scripts/test-database-integration.sh
```

## ğŸ“š æ–‡æ¡£

- [è¯¦ç»†ä½¿ç”¨è¯´æ˜](docs/database-api-integration.md)
- [API å‚è€ƒæ–‡æ¡£](docs/api-reference.md)
- [æ¶æ„è®¾è®¡æ–‡æ¡£](docs/architecture.md)

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬å‡çº§

1. **æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç ** - æ‰€æœ‰ç°æœ‰ API ä¿æŒå…¼å®¹
2. **å¯é€‰å¯ç”¨æ•°æ®åº“** - é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶
3. **æ¸è¿›å¼é‡‡ç”¨** - å¯ä»¥é€æ­¥ä½¿ç”¨æ–°çš„æ•°æ®åº“ API

### æ•°æ®è¿ç§»

```bash
# é¦–æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨è¿è¡Œæ•°æ®åº“è¿ç§»
ENABLE_DATABASE=true ./bin/server

# æ‰‹åŠ¨è¿è¡Œè¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
./bin/migrate up
```

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°èµ„æºç±»å‹

1. åˆ›å»ºæ•°æ®æ¨¡å‹ (`internal/database/models/`)
2. å®ç°ä»“å‚¨æ¥å£ (`internal/repository/`)
3. åˆ›å»ºæœåŠ¡å±‚ (`internal/core/`)
4. æ·»åŠ  API å¤„ç†å™¨ (`internal/api/`)
5. æ›´æ–°è·¯ç”±é…ç½®

### è‡ªå®šä¹‰æŸ¥è¯¢

```go
// åœ¨ä»“å‚¨å±‚æ·»åŠ è‡ªå®šä¹‰æŸ¥è¯¢
func (r *DeploymentRepository) GetByDateRange(ctx context.Context, start, end time.Time) ([]*models.Deployment, error) {
    // å®ç°è‡ªå®šä¹‰æŸ¥è¯¢é€»è¾‘
}
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**

   ```bash
   # æ£€æŸ¥é…ç½®
   echo $ENABLE_DATABASE $DB_TYPE $DB_HOST
   
   # æ£€æŸ¥æ•°æ®åº“æœåŠ¡
   systemctl status postgresql
   ```

2. **æ•°æ®åŒæ­¥å¤±è´¥**
   - æŸ¥çœ‹åº”ç”¨æ—¥å¿—
   - æ£€æŸ¥æ•°æ®åº“æƒé™
   - éªŒè¯ç½‘ç»œè¿æ¥

3. **æ€§èƒ½é—®é¢˜**
   - è°ƒæ•´è¿æ¥æ± å¤§å°
   - ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢
   - ç›‘æ§æ•°æ®åº“æ€§èƒ½

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç å’Œåé¦ˆï¼

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] æ”¯æŒæ›´å¤šèµ„æºç±»å‹ (Pod, Node, ConfigMap ç­‰)
- [ ] æ·»åŠ æ•°æ®å¯¼å‡ºåŠŸèƒ½
- [ ] å®ç°å®æ—¶æ•°æ®åŒæ­¥
- [ ] æ·»åŠ æ•°æ®å¯è§†åŒ–é¢æ¿
- [ ] æ”¯æŒå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

---

**ğŸ‰ äº«å—æ–°çš„æ•°æ®åº“ API æ•´åˆåŠŸèƒ½ï¼å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ–‡æ¡£æˆ–æäº¤ Issueã€‚**
